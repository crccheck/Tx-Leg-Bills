<!DOCTYPE html>
<html>
<head>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.0/jquery-ui.min.js"></script>
<script src="http://localhost:5984/_utils/script/jquery.couch.js"></script>
<meta charset=utf-8 />
<title>Key Fix</title>
<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
</head>
<body>
<ul id="keys">

</ul>

<script>
window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){console.log(Array.prototype.slice.call(arguments))}};

var key_data_cache = {};
var key_elem_cache = {};
var request;

function addfix(goodKey, badKey){
    badKey = escape(badKey);
    $.ajax({
        url: '/couch/lobbying_keyfix/'+badKey,
        data: {data: goodKey},
        type: 'POST',
        dataType: 'json',
        error: function(req, text, error){
            log(req, text, error);
        },
        success: function(data, test, req){
            log(data, test, req);
        }
    });
}

function display_key_data(elem, key, value){
    function _display_key_data(elem, key, value){
        var $elem = $(elem);
        if ($elem.hasClass('loaded')) return;
        var output = '';
        if (value.city){
            output += '<span class="city">' + value.city + '</span>';
        }
        if (value.zip){
            output += '<span class="zip">' + value.zip + '</span>';
        }
        $elem.append(output).addClass('loaded');
    }
    function load_key_data(key){
        key = escape(key);
        // todo debounce
        // todo scan for next !.has('loaded') to intelligently come up with an endkey
        return $.getJSON('/couch/lobbying_expenditures/_design/view/_view/places_to_doc?group_level=1&startkey="'+key+'"&limit=30',
            function(jsonData){
                jsonData.rows.forEach(function(row){
                    key_data_cache[row.key] = row.value;
                    display_key_data(key_elem_cache[row.key], row.key, row.value);
                });
            });
    }
    if (value || (value = key_data_cache[key])){
        _display_key_data(elem, key, value);
    } else {
        load_key_data(key);
    }
}

function combine($parent, $child){
    var newUl = $parent.closest('ul'),
        oldUl = $child.closest('ul');
    if (newUl[0] == $('#keys')[0]){
        newUl = $parent.wrap('<li><ul/></li>').parent();
    } else if (newUl[0] == oldUl[0]) {
        newUl.prepend($child);
        return;
    }
    newUl.append($child);
}
(function load_data(){
    $.getJSON("/couch/lobbying_expenditures/_design/view/_view/places?group_level=1",
        function(jsonData){
            var keys = $('#keys');
            jsonData.rows.forEach(function(row){
                elem = $('<li><span class="key">' + row.key + '</span></li>')
                    .click(function(){
                        if (!$(this).hasClass('loaded')) {
                            display_key_data(this, row.key);
                        }
                    })
                    .hide()
                    .appendTo(keys);
                key_elem_cache[row.key] = elem;
            });
            keys.children()
                .draggable({addClasses: false, revert: true, zIndex: 1})
                .droppable({addClasses: false,
                            drop: function(e, ui){ combine($(e.target), ui.draggable); }})
                .show();

        });
})();
</script>
</body>
</html>
