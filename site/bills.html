<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script src="protovis/protovis-d3.2.js"></script>
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
<meta charset=utf-8 />
<title>Billz</title>
<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<style>
  article, aside, figure, footer, header, hgroup,
  menu, nav, section { display: block; }
body {
  margin: 0;
  font-family: helvetica, arial, sans-serif;
  font-size: 10px;
}
#main { white-space:nowrap; }
#main > * { display: inline-block; vertical-align: top; }
#left { height: 1000px; position: relative; width: 300px; }
#left h1 { font-size: 2em; margin: 0; position: absolute; }
    #list { border-right: 1px solid gray; height: 970px; margin-top:30px; overflow: auto; padding: 0 1em 0 2.5em; white-space: normal; }
    #list > li { list-style: decimal outside; margin-bottom: 0.2em; }
    #list > li > a { color: inherit; font-weight: bold; }
</style>
</head>
<body>
<div id="main">
<section id="left">
    <h1>Bill Viz = Billz</h1>
    <ol id="list"></ol>
</section>
<section id="canvas">
</section>
</div>

<script type="text/javascript+protovis">
window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){console.log(Array.prototype.slice.call(arguments))}};

var subjects = {},
    bills = {},
    data, vis;

function load_data(){
    $.getJSON("/couch/bills/_design/viz/_view/subject?group_level=1",
        function(jsonData){
            log('Grabbed Bill Subject Stats');
            data = jsonData.rows.map(function(elem){ out = {}; out[elem.key] = elem.value; return out; });
            main();
        });
}
function load_subjects(){
    $.getJSON("/couch/bills/_design/all/_view/subjects?group=true",
        function(data){
            log('Grabbed Bill Subject Lookup Table');
            data.rows.forEach(function(elem){ subjects[elem.key] = elem.value; });
            load_data();
        });
}
function display_subject_captions(text){
    var parent = $('#list');
    parent.children().remove();
    text.forEach(function(bill){
        $('<li><a href="'+bill.url+'" target="_bill">'+bill.bill+'</a> '+bill.caption+'</li>').appendTo(parent);
    });
}
function load_subject_captions(key){
    if (bills[key]) display_subject_captions(bills[key]);
    $.getJSON("/couch/bills/_design/viz/_view/subject-captions",
        {key: '"' + key + '"'},
        function(data){
            bills[key] = data.rows.map(function(elem){ var b = elem.value; b['bill']=elem.id.split('-')[1]; return b; });
            display_subject_captions(bills[key]);
        });
}
function main(){
    /* Produce a flat hierarchy of the Flare classes. */
    var classes = pv.nodes(pv.flatten(data).leaf(Number).array());
    classes.slice(1).forEach(function(d, idx) {
      //console.log(d.nodeValue);
      //d.nodeName = "flare." + d.nodeValue.keys.join(".");
      d.nodeName = subjects[d.nodeValue.keys[1]];
      //var i = d.nodeName.lastIndexOf(".");
      //d.className = d.nodeName.substring(i + 1);
      //d.packageName = d.nodeName.substring(0, i);
      //d.nodeValue = d.nodeValue.value;
      d.subjectId = d.nodeValue.keys[1];
      d.fillStyleClass = d.nodeName.split(/\W/)[0];
      d.nodeValue = d.nodeValue.value;
    });

    /* For pretty number formatting. */
    var format = pv.Format.number();

    vis = new pv.Panel()
        .width(1000)
        .height(1000)
        .canvas('canvas');

    vis.add(pv.Layout.Pack)
        .top(-50)
        .bottom(-50)
        .nodes(classes)
        .size(function(d) d.nodeValue)
        .spacing(0)
        .order(null)
        .node.add(pv.Dot)
        .fillStyle(pv.Colors.category20().by(function(d) d.fillStyleClass))
        .strokeStyle(function() this.fillStyle().darker())
        .visible(function(d) d.parentNode)
        .title(function(d) d.nodeName + ": " + format(d.nodeValue))
        .event("click", function(d) { $('h1').text(d.nodeName); load_subject_captions(d.subjectId); })
        .anchor("center").add(pv.Label)
        .text(function(d) d.nodeName.substring(0, 1 + (d.nodeValue >> 1)));
        //.text(function(d) d.className.substring(0, Math.sqrt(d.nodeValue) >> 4));

    vis.render();
}
load_subjects();

</script>
</body>
</html>
